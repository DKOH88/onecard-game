<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›ì¹´ë“œ ì˜¨ë¼ì¸ ğŸƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans KR', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a472a 0%, #0d2818 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            color: white;
            overflow-x: hidden;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* ë¡œë¹„ ìŠ¤íƒ€ì¼ */
        .lobby-container {
            background: rgba(0, 0, 0, 0.5);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            margin-top: 50px;
        }

        .lobby-container h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            color: white;
        }

        .btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .room-code-display {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            letter-spacing: 5px;
        }

        .player-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .player-item.host::after {
            content: 'ğŸ‘‘';
            margin-left: 5px;
        }

        .player-item.me {
            background: rgba(74, 222, 128, 0.2);
            border-radius: 5px;
        }

        .connection-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ade80;
        }

        .connection-status.offline {
            background: #ef4444;
        }

        /* ê²Œì„ ì˜ì—­ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ê³¼ ë™ì¼) */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 900px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .direction-indicator {
            font-size: 1.3rem;
            padding: 5px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .game-table {
            position: relative;
            width: 100%;
            max-width: 900px;
            height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .player-slot {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s;
        }

        .player-slot.top {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        .player-slot.bottom {
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        .player-slot.left {
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }

        .player-slot.right {
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }

        .player-slot.top-left {
            top: 10%;
            left: 10%;
        }

        .player-slot.top-right {
            top: 10%;
            right: 10%;
        }

        .player-area {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 15px;
            min-width: 150px;
        }

        .player-area.current-turn {
            box-shadow: 0 0 20px #4ade80;
            border: 2px solid #4ade80;
        }

        .player-label {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .card-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85rem;
        }

        .cards-row {
            display: flex;
            gap: -15px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 350px;
        }

        .card {
            width: 50px;
            height: 70px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: -15px;
            border: 2px solid #333;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }

        .card:first-child {
            margin-left: 0;
        }

        .card:hover:not(.disabled) {
            transform: translateY(-10px);
            z-index: 10;
        }

        .card.selected {
            transform: translateY(-20px);
            box-shadow: 0 0 15px #4ade80;
            border-color: #4ade80;
        }

        .card.playable {
            border-color: #4ade80;
        }

        .card-back {
            background: linear-gradient(135deg, #1e3a5f, #0f1f35);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card-back::after {
            content: 'ğŸƒ';
        }

        /* ì¹´ë“œ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .card.spade,
        .card.club,
        .card.heart,
        .card.diamond {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: transparent;
            text-shadow: none;
        }

        .card.spade.val-A {
            background-image: url('cards/spade/A.png');
        }

        .card.spade.val-2 {
            background-image: url('cards/spade/2.png');
        }

        .card.spade.val-3 {
            background-image: url('cards/spade/3.png');
        }

        .card.spade.val-4 {
            background-image: url('cards/spade/4.png');
        }

        .card.spade.val-5 {
            background-image: url('cards/spade/5.png');
        }

        .card.spade.val-6 {
            background-image: url('cards/spade/6.png');
        }

        .card.spade.val-7 {
            background-image: url('cards/spade/7.png');
        }

        .card.spade.val-8 {
            background-image: url('cards/spade/8.png');
        }

        .card.spade.val-9 {
            background-image: url('cards/spade/9.png');
        }

        .card.spade.val-10 {
            background-image: url('cards/spade/10.png');
        }

        .card.spade.val-J {
            background-image: url('cards/spade/J.png');
        }

        .card.spade.val-Q {
            background-image: url('cards/spade/Q.png');
        }

        .card.spade.val-K {
            background-image: url('cards/spade/K.png');
        }

        .card.club.val-A {
            background-image: url('cards/club/A.png');
        }

        .card.club.val-2 {
            background-image: url('cards/club/2.png');
        }

        .card.club.val-3 {
            background-image: url('cards/club/3.png');
        }

        .card.club.val-4 {
            background-image: url('cards/club/4.png');
        }

        .card.club.val-5 {
            background-image: url('cards/club/5.png');
        }

        .card.club.val-6 {
            background-image: url('cards/club/6.png');
        }

        .card.club.val-7 {
            background-image: url('cards/club/7.png');
        }

        .card.club.val-8 {
            background-image: url('cards/club/8.png');
        }

        .card.club.val-9 {
            background-image: url('cards/club/9.png');
        }

        .card.club.val-10 {
            background-image: url('cards/club/10.png');
        }

        .card.club.val-J {
            background-image: url('cards/club/J.png');
        }

        .card.club.val-Q {
            background-image: url('cards/club/Q.png');
        }

        .card.club.val-K {
            background-image: url('cards/club/K.png');
        }

        .card.heart.val-A {
            background-image: url('cards/heart/A.png');
        }

        .card.heart.val-2 {
            background-image: url('cards/heart/2.png');
        }

        .card.heart.val-3 {
            background-image: url('cards/heart/3.png');
        }

        .card.heart.val-4 {
            background-image: url('cards/heart/4.png');
        }

        .card.heart.val-5 {
            background-image: url('cards/heart/5.png');
        }

        .card.heart.val-6 {
            background-image: url('cards/heart/6.png');
        }

        .card.heart.val-7 {
            background-image: url('cards/heart/7.png');
        }

        .card.heart.val-8 {
            background-image: url('cards/heart/8.png');
        }

        .card.heart.val-9 {
            background-image: url('cards/heart/9.png');
        }

        .card.heart.val-10 {
            background-image: url('cards/heart/10.png');
        }

        .card.heart.val-J {
            background-image: url('cards/heart/J.png');
        }

        .card.heart.val-Q {
            background-image: url('cards/heart/Q.png');
        }

        .card.heart.val-K {
            background-image: url('cards/heart/K.png');
        }

        .card.diamond.val-A {
            background-image: url('cards/diamond/A.png');
        }

        .card.diamond.val-2 {
            background-image: url('cards/diamond/2.png');
        }

        .card.diamond.val-3 {
            background-image: url('cards/diamond/3.png');
        }

        .card.diamond.val-4 {
            background-image: url('cards/diamond/4.png');
        }

        .card.diamond.val-5 {
            background-image: url('cards/diamond/5.png');
        }

        .card.diamond.val-6 {
            background-image: url('cards/diamond/6.png');
        }

        .card.diamond.val-7 {
            background-image: url('cards/diamond/7.png');
        }

        .card.diamond.val-8 {
            background-image: url('cards/diamond/8.png');
        }

        .card.diamond.val-9 {
            background-image: url('cards/diamond/9.png');
        }

        .card.diamond.val-10 {
            background-image: url('cards/diamond/10.png');
        }

        .card.diamond.val-J {
            background-image: url('cards/diamond/J.png');
        }

        .card.diamond.val-Q {
            background-image: url('cards/diamond/Q.png');
        }

        .card.diamond.val-K {
            background-image: url('cards/diamond/K.png');
        }

        .card.black-joker {
            background: url('cards/black_joker.png') center/cover;
            color: transparent;
        }

        .card.color-joker {
            background: url('cards/color_joker.png') center/cover;
            color: transparent;
        }

        .center-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .deck-area {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .deck {
            position: relative;
            width: 60px;
            height: 85px;
        }

        .deck .card-back {
            position: absolute;
            width: 60px;
            height: 85px;
            cursor: pointer;
        }

        .discard-pile {
            display: flex;
            align-items: center;
        }

        #discard-cards {
            display: flex;
            align-items: center;
        }

        .message-box {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.1rem;
            text-align: center;
            min-width: 200px;
        }

        .message-box.attack {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            animation: pulse 0.5s infinite alternate;
        }

        @keyframes pulse {
            from {
                transform: scale(1);
            }

            to {
                transform: scale(1.05);
            }
        }

        .action-buttons {
            display: none;
            gap: 10px;
            margin-top: 10px;
        }

        .suit-selector {
            display: none;
            gap: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 15px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
        }

        .suit-btn {
            font-size: 2rem;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: white;
        }

        .hidden {
            display: none !important;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 600px) {
            .game-table {
                height: 500px;
            }

            .card {
                width: 40px;
                height: 56px;
            }
        }
    </style>
</head>

<body>
    <h1>ğŸƒ ì›ì¹´ë“œ ì˜¨ë¼ì¸</h1>

    <!-- ë¡œë¹„ í™”ë©´ -->
    <div class="lobby-container" id="lobby-screen">
        <h2>ğŸ® ê²Œì„ ë¡œë¹„</h2>

        <div id="main-menu">
            <div class="input-group">
                <label>ë‹‰ë„¤ì„</label>
                <input type="text" id="nickname-input" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
            </div>
            <button class="btn btn-primary" onclick="createRoom()">ğŸ  ë°© ë§Œë“¤ê¸°</button>
            <button class="btn btn-secondary" onclick="showJoinForm()">ğŸšª ë°© ì°¸ê°€í•˜ê¸°</button>
        </div>

        <div id="join-form" class="hidden">
            <div class="input-group">
                <label>ë°© ì½”ë“œ</label>
                <input type="text" id="room-code-input" placeholder="6ìë¦¬ ì½”ë“œ ì…ë ¥" maxlength="6"
                    style="text-transform: uppercase;">
            </div>
            <button class="btn btn-primary" onclick="joinRoom()">ì°¸ê°€í•˜ê¸°</button>
            <button class="btn btn-secondary" onclick="hideJoinForm()">ì·¨ì†Œ</button>
        </div>

        <div id="waiting-room" class="hidden">
            <div class="room-code-display" id="room-code-display">------</div>
            <p style="text-align:center;margin-bottom:10px;">ì¹œêµ¬ì—ê²Œ ì´ ì½”ë“œë¥¼ ê³µìœ í•˜ì„¸ìš”!</p>

            <div class="player-list" id="player-list">
                <!-- í”Œë ˆì´ì–´ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë¨ -->
            </div>

            <div id="host-controls" class="hidden">
                <button class="btn btn-primary" onclick="startOnlineGame()" id="start-game-btn" disabled>
                    ğŸ® ê²Œì„ ì‹œì‘ (ìµœì†Œ 2ëª… í•„ìš”)
                </button>
            </div>

            <button class="btn btn-secondary" onclick="leaveRoom()">ğŸšª ë‚˜ê°€ê¸°</button>
        </div>
    </div>

    <!-- ê²Œì„ í™”ë©´ -->
    <div id="game-screen" class="hidden" style="width:100%;max-width:900px;">
        <div class="game-header">
            <div>
                <span id="turn-text">ëŒ€ê¸° ì¤‘...</span>
            </div>
            <div class="direction-indicator" id="direction">âŸ³ ì‹œê³„</div>
            <div>
                <span id="deck-count">ë±: 0</span>
            </div>
        </div>

        <div class="game-table">
            <div class="player-slot top" id="slot-top"></div>
            <div class="player-slot left" id="slot-left"></div>
            <div class="player-slot right" id="slot-right"></div>
            <div class="player-slot top-left" id="slot-top-left"></div>
            <div class="player-slot top-right" id="slot-top-right"></div>

            <div class="center-area">
                <div class="deck-area">
                    <div class="deck" onclick="drawCardOnline()">
                        <div class="card-back"></div>
                    </div>
                    <div class="discard-pile" id="discard-cards"></div>
                </div>
                <div class="message-box" id="message">ê²Œì„ ì‹œì‘!</div>
                <div class="action-buttons" id="action-buttons">
                    <button class="btn btn-primary" onclick="playSelectedCardsOnline()">ì¹´ë“œ ë‚´ê¸°</button>
                    <button class="btn btn-secondary" onclick="clearSelection()">ì·¨ì†Œ</button>
                </div>
            </div>

            <div class="player-slot bottom" id="slot-bottom"></div>
        </div>
    </div>

    <!-- ë¬´ëŠ¬ ì„ íƒ -->
    <div class="suit-selector" id="suit-selector">
        <button class="suit-btn" onclick="selectSuitOnline('spade')">â™ </button>
        <button class="suit-btn" onclick="selectSuitOnline('heart')">â™¥</button>
        <button class="suit-btn" onclick="selectSuitOnline('diamond')">â™¦</button>
        <button class="suit-btn" onclick="selectSuitOnline('club')">â™£</button>
    </div>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            databaseURL: "https://dkcard-89e9c-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ê²Œì„ ìƒíƒœ
        let myPlayerId = null;
        let myNickname = '';
        let currentRoomCode = null;
        let isHost = false;
        let roomRef = null;
        let gameState = null;
        let players = [];
        let selectedCards = [];

        const suitSymbols = {
            'spade': 'â™ ', 'heart': 'â™¥', 'diamond': 'â™¦', 'club': 'â™£'
        };

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function generatePlayerId() {
            return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ë¡œë¹„ í•¨ìˆ˜
        function showJoinForm() {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('join-form').classList.remove('hidden');
        }

        function hideJoinForm() {
            document.getElementById('join-form').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
        }

        function createRoom() {
            myNickname = document.getElementById('nickname-input').value.trim();
            if (!myNickname) {
                alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            myPlayerId = generatePlayerId();
            currentRoomCode = generateRoomCode();
            isHost = true;

            roomRef = database.ref('rooms/' + currentRoomCode);

            roomRef.set({
                host: myPlayerId,
                status: 'waiting',
                createdAt: Date.now(),
                players: {
                    [myPlayerId]: {
                        name: myNickname,
                        connected: true,
                        joinedAt: Date.now()
                    }
                }
            }).then(() => {
                showWaitingRoom();
                listenToRoom();
                setupDisconnectHandler();
            }).catch(err => {
                alert('ë°© ìƒì„± ì‹¤íŒ¨: ' + err.message);
            });
        }

        function joinRoom() {
            myNickname = document.getElementById('nickname-input').value.trim();
            const roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();

            if (!myNickname) {
                alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            if (!roomCode || roomCode.length !== 6) {
                alert('ì˜¬ë°”ë¥¸ ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            myPlayerId = generatePlayerId();
            currentRoomCode = roomCode;
            roomRef = database.ref('rooms/' + currentRoomCode);

            roomRef.once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤!');
                    return;
                }

                const roomData = snapshot.val();
                if (roomData.status !== 'waiting') {
                    alert('ì´ë¯¸ ê²Œì„ì´ ì‹œì‘ëœ ë°©ì…ë‹ˆë‹¤!');
                    return;
                }

                const playerCount = Object.keys(roomData.players || {}).length;
                if (playerCount >= 6) {
                    alert('ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤! (ìµœëŒ€ 6ëª…)');
                    return;
                }

                isHost = false;
                roomRef.child('players/' + myPlayerId).set({
                    name: myNickname,
                    connected: true,
                    joinedAt: Date.now()
                }).then(() => {
                    hideJoinForm();
                    showWaitingRoom();
                    listenToRoom();
                    setupDisconnectHandler();
                });
            });
        }

        function showWaitingRoom() {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('join-form').classList.add('hidden');
            document.getElementById('waiting-room').classList.remove('hidden');
            document.getElementById('room-code-display').textContent = currentRoomCode;

            if (isHost) {
                document.getElementById('host-controls').classList.remove('hidden');
            }
        }

        function setupDisconnectHandler() {
            roomRef.child('players/' + myPlayerId + '/connected').onDisconnect().set(false);
        }

        function listenToRoom() {
            roomRef.on('value', snapshot => {
                if (!snapshot.exists()) {
                    alert('ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    location.reload();
                    return;
                }

                const roomData = snapshot.val();

                // ê²Œì„ ì‹œì‘ í™•ì¸
                if (roomData.status === 'playing' && roomData.gameState) {
                    gameState = roomData.gameState;
                    players = [];
                    const playerOrder = roomData.gameState.playerOrder || [];

                    // ë‚´ ìœ„ì¹˜(ì¸ë±ìŠ¤) ë¨¼ì € ì°¾ê¸°
                    const myIndex = playerOrder.indexOf(myPlayerId);

                    playerOrder.forEach((pid, idx) => {
                        const pData = roomData.players[pid];
                        const handData = roomData.gameState.hands ? roomData.gameState.hands[pid] : [];
                        players.push({
                            id: pid,
                            name: pData.name,
                            hand: handData || [],
                            isMe: pid === myPlayerId,
                            isBankrupt: pData.isBankrupt || false,
                            rank: pData.rank || null,
                            slot: getSlotForPlayer(idx, playerOrder.length, myIndex)
                        });
                    });
                    showGameScreen();
                    render();
                    return;
                }

                // ëŒ€ê¸°ì‹¤ í”Œë ˆì´ì–´ ëª©ë¡ ì—…ë°ì´íŠ¸
                updatePlayerList(roomData);
            });
        }

        function updatePlayerList(roomData) {
            const playerListEl = document.getElementById('player-list');
            const playersData = roomData.players || {};
            const hostId = roomData.host;

            let html = '';
            let connectedCount = 0;

            Object.entries(playersData).forEach(([pid, pData]) => {
                const isMe = pid === myPlayerId;
                const isHostPlayer = pid === hostId;
                const isConnected = pData.connected;

                if (isConnected) connectedCount++;

                html += `
                    <div class="player-item ${isHostPlayer ? 'host' : ''} ${isMe ? 'me' : ''}">
                        <span>${pData.name} ${isMe ? '(ë‚˜)' : ''}</span>
                        <div class="connection-status ${isConnected ? '' : 'offline'}"></div>
                    </div>
                `;
            });

            playerListEl.innerHTML = html;

            // ì‹œì‘ ë²„íŠ¼ í™œì„±í™”
            const startBtn = document.getElementById('start-game-btn');
            if (startBtn) {
                if (connectedCount >= 2) {
                    startBtn.disabled = false;
                    startBtn.textContent = `ğŸ® ê²Œì„ ì‹œì‘ (${connectedCount}ëª…)`;
                } else {
                    startBtn.disabled = true;
                    startBtn.textContent = 'ğŸ® ê²Œì„ ì‹œì‘ (ìµœì†Œ 2ëª… í•„ìš”)';
                }
            }
        }

        function getSlotForPlayer(index, totalPlayers, myIndex) {
            // myIndexê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
            if (myIndex < 0) myIndex = 0;
            const relativeIndex = (index - myIndex + totalPlayers) % totalPlayers;

            const slots = {
                2: ['bottom', 'top'],
                3: ['bottom', 'left', 'top'],
                4: ['bottom', 'left', 'top', 'right'],
                5: ['bottom', 'left', 'top-left', 'top-right', 'right'],
                6: ['bottom', 'left', 'top-left', 'top', 'top-right', 'right']
            };

            return slots[totalPlayers] ? slots[totalPlayers][relativeIndex] : 'bottom';
        }

        function leaveRoom() {
            if (roomRef) {
                roomRef.child('players/' + myPlayerId).remove();
                roomRef.off();
            }
            location.reload();
        }

        // ê²Œì„ ì‹œì‘ (ë°©ì¥ë§Œ)
        function startOnlineGame() {
            if (!isHost) return;

            roomRef.once('value').then(snapshot => {
                const roomData = snapshot.val();
                const playerIds = Object.keys(roomData.players).filter(pid => roomData.players[pid].connected);

                if (playerIds.length < 2) {
                    alert('ìµœì†Œ 2ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                    return;
                }

                // ë± ìƒì„± ë° ì…”í”Œ
                const deck = createDeck();
                shuffle(deck);

                // ì¹´ë“œ ë¶„ë°° (5ì¥ì”©)
                const hands = {};
                playerIds.forEach(pid => {
                    hands[pid] = [];
                    for (let i = 0; i < 5; i++) {
                        hands[pid].push(deck.pop());
                    }
                });

                // ì²« ì¹´ë“œ (íŠ¹ìˆ˜ ì¹´ë“œ ì œì™¸)
                let firstCard;
                do {
                    firstCard = deck.pop();
                    if (isSpecialCard(firstCard)) {
                        deck.unshift(firstCard);
                    } else {
                        break;
                    }
                } while (true);

                // ê²Œì„ ìƒíƒœ ì €ì¥
                roomRef.update({
                    status: 'playing',
                    gameState: {
                        deck: deck,
                        discardPile: [firstCard],
                        currentPlayerIndex: 0,
                        direction: 1,
                        attackStack: 0,
                        attackType: null,
                        currentSuit: firstCard.suit,
                        skipTurns: 0,
                        playerOrder: playerIds,
                        hands: hands
                    }
                });
            });
        }

        function createDeck() {
            const suits = ['spade', 'heart', 'diamond', 'club'];
            const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const deck = [];

            for (let suit of suits) {
                for (let value of values) {
                    deck.push({ suit, value });
                }
            }
            deck.push({ suit: 'black-joker', value: 'JOKER' });
            deck.push({ suit: 'color-joker', value: 'JOKER' });

            return deck;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function isSpecialCard(card) {
            return card.value === '2' || card.value === 'A' ||
                card.value === 'J' || card.value === 'Q' || card.value === 'K' ||
                card.suit === 'black-joker' || card.suit === 'color-joker';
        }

        function showGameScreen() {
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
        }

        // ê²Œì„ ë Œë”ë§
        function render() {
            if (!gameState) return;

            document.getElementById('direction').textContent = gameState.direction === 1 ? 'âŸ³ ì‹œê³„' : 'âŸ² ë°˜ì‹œê³„';
            document.getElementById('deck-count').textContent = `ë±: ${gameState.deck.length}`;

            // ìŠ¬ë¡¯ ì´ˆê¸°í™”
            ['top', 'left', 'right', 'bottom', 'top-left', 'top-right'].forEach(slot => {
                const el = document.getElementById('slot-' + slot);
                if (el) el.innerHTML = '';
            });

            // í˜„ì¬ í„´ í”Œë ˆì´ì–´
            const currentPlayer = players[gameState.currentPlayerIndex];
            const isMyTurn = currentPlayer && currentPlayer.isMe;

            document.getElementById('turn-text').textContent = currentPlayer ?
                `${currentPlayer.name}ì˜ í„´` : '';

            // í”Œë ˆì´ì–´ ë Œë”ë§
            players.forEach((p, idx) => {
                const slotEl = document.getElementById('slot-' + p.slot);
                if (!slotEl) return;

                const isCurrent = gameState.currentPlayerIndex === idx;

                if (p.isMe) {
                    // ë‚´ ì¹´ë“œ (ì•ë©´)
                    slotEl.innerHTML = `
                        <div class="player-area ${isCurrent ? 'current-turn' : ''}">
                            <div class="player-label">
                                ${p.name} (ë‚˜)
                                <span class="card-count">${p.hand.length}ì¥</span>
                            </div>
                            <div class="cards-row">
                                ${p.hand.map((card, i) => {
                        const playable = isCurrent && canPlayCard(card);
                        const selected = selectedCards.includes(i);
                        const isNormalSuit = ['spade', 'heart', 'diamond', 'club'].includes(card.suit);
                        const valueClass = isNormalSuit ? `val-${card.value}` : '';
                        return `
                                        <div class="card ${card.suit} ${valueClass} ${playable ? 'playable' : ''} ${selected ? 'selected' : ''}"
                                             onclick="toggleCardSelection(${i})">
                                        </div>
                                    `;
                    }).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    // ìƒëŒ€ ì¹´ë“œ (ë’·ë©´)
                    slotEl.innerHTML = `
                        <div class="player-area ${isCurrent ? 'current-turn' : ''}">
                            <div class="player-label">
                                ${p.name}
                                <span class="card-count">${p.hand.length}ì¥</span>
                            </div>
                            <div class="cards-row">
                                ${p.hand.map(() => `<div class="card card-back"></div>`).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            // ë²„ë¦° ì¹´ë“œ ë”ë¯¸
            const discardEl = document.getElementById('discard-cards');
            const topCards = gameState.discardPile.slice(-3);
            discardEl.innerHTML = topCards.map((card, idx) => {
                const isTop = idx === topCards.length - 1;
                const isNormalSuit = ['spade', 'heart', 'diamond', 'club'].includes(card.suit);
                const valueClass = isNormalSuit ? `val-${card.value}` : '';
                const opacity = isTop ? '1' : (idx === topCards.length - 2 ? '0.7' : '0.4');
                return `
                    <div class="card ${card.suit} ${valueClass}" 
                         style="width:${isTop ? 60 : 45}px;height:${isTop ? 85 : 65}px;opacity:${opacity};cursor:default;">
                    </div>
                `;
            }).join('');

            // ì•¡ì…˜ ë²„íŠ¼
            document.getElementById('action-buttons').style.display = selectedCards.length > 0 ? 'flex' : 'none';

            // ë©”ì‹œì§€
            if (gameState.attackStack > 0) {
                setMessage(`âš”ï¸ ${gameState.attackStack}ì¥ ê³µê²©!`, 'attack');
            } else if (isMyTurn) {
                setMessage('ë‹¹ì‹ ì˜ í„´ì…ë‹ˆë‹¤');
            }
        }

        function setMessage(text, type = '') {
            const msgBox = document.getElementById('message');
            msgBox.textContent = text;
            msgBox.className = 'message-box' + (type ? ' ' + type : '');
        }

        function canPlayCard(card) {
            const currentPlayer = players[gameState.currentPlayerIndex];
            if (!currentPlayer || !currentPlayer.isMe) return false;

            if (gameState.attackStack > 0) {
                return canDefendWith(card);
            }

            const topCard = gameState.discardPile[gameState.discardPile.length - 1];

            if (card.suit === 'black-joker' || card.suit === 'color-joker') return true;
            if (card.suit === gameState.currentSuit) return true;
            if (card.value === topCard.value) return true;

            return false;
        }

        function canDefendWith(card) {
            const attackType = gameState.attackType;
            if (!attackType) return true;

            if (attackType === '2') {
                if (card.value === '2') return true;
                if (card.value === 'A' && card.suit === gameState.currentSuit) return true;
                if (card.suit === 'black-joker' || card.suit === 'color-joker') return true;
                return false;
            }
            if (attackType === 'A') {
                if (card.value === 'A') return true;
                if (card.suit === 'black-joker' || card.suit === 'color-joker') return true;
                return false;
            }
            if (attackType === 'black-joker') {
                if (card.value === 'A' && card.suit === 'spade') return true;
                if (card.suit === 'black-joker' || card.suit === 'color-joker') return true;
                return false;
            }
            if (attackType === 'color-joker') {
                if (card.value === 'A' && card.suit === 'spade') return true;
                if (card.suit === 'black-joker' || card.suit === 'color-joker') return true;
                return false;
            }
            return false;
        }

        function toggleCardSelection(index) {
            const currentPlayer = players[gameState.currentPlayerIndex];
            if (!currentPlayer || !currentPlayer.isMe) return;

            const card = currentPlayer.hand[index];
            if (!canPlayCard(card)) return;

            const idx = selectedCards.indexOf(index);
            if (idx > -1) {
                selectedCards.splice(idx, 1);
            } else {
                // ê°™ì€ ìˆ«ì ì¹´ë“œë§Œ ì„ íƒ ê°€ëŠ¥
                if (selectedCards.length > 0) {
                    const firstCard = currentPlayer.hand[selectedCards[0]];
                    if (card.value !== firstCard.value) {
                        alert('ê°™ì€ ìˆ«ìì˜ ì¹´ë“œë§Œ í•¨ê»˜ ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
                        return;
                    }
                }
                selectedCards.push(index);
            }
            render();
        }

        function clearSelection() {
            selectedCards = [];
            render();
        }

        // ì˜¨ë¼ì¸ ì¹´ë“œ ë‚´ê¸°
        function playSelectedCardsOnline() {
            if (selectedCards.length === 0) return;

            const myPlayer = players.find(p => p.isMe);
            if (!myPlayer) return;

            const cardsToPlay = selectedCards.map(i => myPlayer.hand[i]);
            const newHand = myPlayer.hand.filter((_, i) => !selectedCards.includes(i));

            // ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
            const newDiscardPile = [...gameState.discardPile, ...cardsToPlay];
            const newDeck = [...gameState.deck];

            let newAttackStack = gameState.attackStack;
            let newAttackType = gameState.attackType;
            let newSkipTurns = gameState.skipTurns;
            let newDirection = gameState.direction;
            let newCurrentSuit = cardsToPlay[0].suit;

            // ì¡°ì»¤ëŠ” ì´ì „ ë¬´ëŠ¬ ìœ ì§€
            if (cardsToPlay[0].suit === 'black-joker' || cardsToPlay[0].suit === 'color-joker') {
                newCurrentSuit = gameState.currentSuit;
            }

            // íŠ¹ìˆ˜ ì¹´ë“œ íš¨ê³¼
            const value = cardsToPlay[0].value;
            const count = cardsToPlay.length;

            if (value === '2') {
                newAttackStack += 2 * count;
                newAttackType = '2';
            } else if (value === 'A') {
                newAttackStack += 3 * count;
                newAttackType = 'A';
            } else if (cardsToPlay[0].suit === 'black-joker') {
                newAttackStack += 5 * count;
                newAttackType = 'black-joker';
            } else if (cardsToPlay[0].suit === 'color-joker') {
                newAttackStack += 7 * count;
                newAttackType = 'color-joker';
            } else if (value === 'K') {
                newSkipTurns += 2 * count;
                newAttackStack = 0;
                newAttackType = null;
            } else if (value === 'Q') {
                if (count % 2 === 1) {
                    newDirection *= -1;
                }
                newAttackStack = 0;
                newAttackType = null;
            } else if (value === 'J') {
                newSkipTurns += 1 * count;
                newAttackStack = 0;
                newAttackType = null;
            } else {
                newAttackStack = 0;
                newAttackType = null;
            }

            // ë‹¤ìŒ í„´
            let nextPlayerIndex = gameState.currentPlayerIndex;
            const activePlayers = players.filter(p => !p.isBankrupt && p.rank === null);

            // ìŠ¤í‚µ ì²˜ë¦¬
            for (let i = 0; i <= newSkipTurns; i++) {
                nextPlayerIndex = (nextPlayerIndex + newDirection + players.length) % players.length;
            }
            newSkipTurns = 0;

            // 7ì¹´ë“œ ë¬´ëŠ¬ ì„ íƒì´ í•„ìš”í•œ ê²½ìš°
            if (value === '7' && cardsToPlay[0].suit !== 'black-joker' && cardsToPlay[0].suit !== 'color-joker') {
                document.getElementById('suit-selector').style.display = 'flex';
                // ì„ì‹œ ì €ì¥
                window.pendingUpdate = {
                    newHand, newDiscardPile, newDeck, newAttackStack, newAttackType,
                    newSkipTurns, newDirection, nextPlayerIndex
                };
                selectedCards = [];
                return;
            }

            // Firebase ì—…ë°ì´íŠ¸
            updateGameState({
                deck: newDeck,
                discardPile: newDiscardPile,
                currentPlayerIndex: nextPlayerIndex,
                direction: newDirection,
                attackStack: newAttackStack,
                attackType: newAttackType,
                currentSuit: newCurrentSuit,
                skipTurns: 0,
                [`hands/${myPlayerId}`]: newHand
            });

            selectedCards = [];
        }

        function selectSuitOnline(suit) {
            document.getElementById('suit-selector').style.display = 'none';

            if (window.pendingUpdate) {
                const { newHand, newDiscardPile, newDeck, newAttackStack, newAttackType,
                    newSkipTurns, newDirection, nextPlayerIndex } = window.pendingUpdate;

                updateGameState({
                    deck: newDeck,
                    discardPile: newDiscardPile,
                    currentPlayerIndex: nextPlayerIndex,
                    direction: newDirection,
                    attackStack: newAttackStack,
                    attackType: newAttackType,
                    currentSuit: suit,
                    skipTurns: 0,
                    [`hands/${myPlayerId}`]: newHand
                });

                window.pendingUpdate = null;
            }
        }

        function drawCardOnline() {
            const currentPlayer = players[gameState.currentPlayerIndex];
            if (!currentPlayer || !currentPlayer.isMe) {
                alert('ë‹¹ì‹ ì˜ í„´ì´ ì•„ë‹™ë‹ˆë‹¤!');
                return;
            }

            const myPlayer = players.find(p => p.isMe);
            if (!myPlayer) return;

            const cardsToDraw = gameState.attackStack > 0 ? gameState.attackStack : 1;
            const newDeck = [...gameState.deck];
            const newHand = [...myPlayer.hand];

            for (let i = 0; i < cardsToDraw; i++) {
                if (newDeck.length === 0) {
                    // ë± ë¦¬ì…”í”Œ
                    const topCard = gameState.discardPile[gameState.discardPile.length - 1];
                    const reshuffled = gameState.discardPile.slice(0, -1);
                    shuffle(reshuffled);
                    newDeck.push(...reshuffled);
                }
                if (newDeck.length > 0) {
                    newHand.push(newDeck.pop());
                }
            }

            // ë‹¤ìŒ í„´
            let nextPlayerIndex = (gameState.currentPlayerIndex + gameState.direction + players.length) % players.length;

            updateGameState({
                deck: newDeck,
                currentPlayerIndex: nextPlayerIndex,
                attackStack: 0,
                attackType: null,
                [`hands/${myPlayerId}`]: newHand
            });
        }

        function updateGameState(updates) {
            const gameStateRef = roomRef.child('gameState');
            gameStateRef.update(updates);
        }
    </script>
</body>

</html>